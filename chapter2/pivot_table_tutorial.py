# -*- coding: utf-8 -*-
"""
pivot_table 用法详解
pandas.DataFrame.pivot_table() 是一个强大的数据透视表工具
"""

import pandas as pd
import numpy as np

# ============================================================================
# 1. 基础用法示例
# ============================================================================

# 创建示例数据
data = {
    '日期': ['2024-01', '2024-01', '2024-01', '2024-02', '2024-02', '2024-02'],
    '产品': ['A', 'B', 'A', 'B', 'A', 'B'],
    '地区': ['北京', '北京', '上海', '上海', '北京', '上海'],
    '销量': [100, 150, 120, 180, 110, 200],
    '收入': [10000, 15000, 12000, 18000, 11000, 20000]
}
df = pd.DataFrame(data)
print("原始数据：")
print(df)

print("\n" + "="*80 + "\n")

# ============================================================================
# 2. 基本参数说明
# ============================================================================
"""
pivot_table 主要参数：
- data: 数据源（DataFrame）
- values: 要聚合的列（可选，默认所有数值列）
- index: 行索引（分组的列）
- columns: 列索引（透视后的列）
- aggfunc: 聚合函数（默认 'mean'）
- fill_value: 填充缺失值
- margins: 是否添加总计行/列
- dropna: 是否删除全为 NaN 的列
"""

# ============================================================================
# 3. 示例1：简单透视表 - 按产品统计平均销量
# ============================================================================
result1 = df.pivot_table(values='销量', index='产品', aggfunc='mean')
print("示例1：按产品统计平均销量")
print(result1)
print("\n" + "="*80 + "\n")

# ============================================================================
# 4. 示例2：多维透视 - 按产品和地区统计
# ============================================================================
result2 = df.pivot_table(values='销量', index='产品', columns='地区', aggfunc='mean')
print("示例2：按产品和地区统计平均销量")
print(result2)
print("\n" + "="*80 + "\n")

# ============================================================================
# 5. 示例3：多个聚合函数
# ============================================================================
result3 = df.pivot_table(
    values='销量', 
    index='产品', 
    columns='地区',
    aggfunc=['sum', 'mean', 'count']
)
print("示例3：使用多个聚合函数（总和、平均、计数）")
print(result3)
print("\n" + "="*80 + "\n")

# ============================================================================
# 6. 示例4：多个值列
# ============================================================================
result4 = df.pivot_table(
    values=['销量', '收入'], 
    index='产品',
    aggfunc='sum'
)
print("示例4：同时统计销量和收入")
print(result4)
print("\n" + "="*80 + "\n")

# ============================================================================
# 7. 示例5：添加总计（margins）
# ============================================================================
result5 = df.pivot_table(
    values='销量',
    index='产品',
    columns='地区',
    aggfunc='sum',
    margins=True,  # 添加总计行和列
    margins_name='总计'
)
print("示例5：添加总计行和列")
print(result5)
print("\n" + "="*80 + "\n")

# ============================================================================
# 8. 示例6：填充缺失值
# ============================================================================
result6 = df.pivot_table(
    values='销量',
    index='产品',
    columns='地区',
    aggfunc='sum',
    fill_value=0  # 用 0 填充缺失值
)
print("示例6：用0填充缺失值")
print(result6)
print("\n" + "="*80 + "\n")

# ============================================================================
# 9. 示例7：自定义聚合函数
# ============================================================================
result7 = df.pivot_table(
    values='销量',
    index='产品',
    aggfunc=lambda x: x.max() - x.min()  # 计算极差
)
print("示例7：使用自定义函数计算极差")
print(result7)
print("\n" + "="*80 + "\n")

# ============================================================================
# 10. 风控场景实战示例：计算按月分箱逾期率
# ============================================================================
print("="*80)
print("风控场景实战：计算按月分箱逾期率（参考 ch2_24 代码）")
print("="*80 + "\n")

# 创建模拟风控数据
np.random.seed(42)
risk_data = pd.DataFrame({
    'age_bin': np.random.choice(['[20-30)', '[30-40)', '[40-50)', '[50-60)'], 100),
    'month': np.random.choice(['2024-01', '2024-02', '2024-03'], 100),
    'is_bad': np.random.choice([0, 1], 100, p=[0.8, 0.2])  # 20%逾期率
})

# 使用 pivot_table 计算各年龄段在不同月份的逾期率
bad_rate_by_month = risk_data.pivot_table(
    index='age_bin',      # 行：年龄分箱
    columns='month',      # 列：月份
    values='is_bad',      # 值：是否逾期
    aggfunc='mean'        # 聚合函数：平均值（即逾期率）
)

print("各年龄段按月逾期率统计：")
print(bad_rate_by_month)
print("\n")

# 计算逾期率的标准差（波动性）
bad_rate_std = bad_rate_by_month.std(axis=1)
print("各年龄段逾期率的标准差（波动性）：")
print(bad_rate_std)
print("\n" + "="*80 + "\n")

# ============================================================================
# 11. 常用聚合函数汇总
# ============================================================================
print("常用聚合函数汇总：")
print("""
- 'mean': 平均值
- 'sum': 总和
- 'count': 计数
- 'min': 最小值
- 'max': 最大值
- 'std': 标准差
- 'var': 方差
- 'median': 中位数
- 'first': 第一个值
- 'last': 最后一个值
- lambda 函数: 自定义聚合逻辑
""")

# ============================================================================
# 12. pivot_table vs groupby 对比
# ============================================================================
print("="*80)
print("pivot_table vs groupby 对比")
print("="*80 + "\n")

# 使用 groupby
result_groupby = df.groupby('产品')['销量'].mean()
print("使用 groupby：")
print(result_groupby)
print()

# 使用 pivot_table（结果相同，但格式更适合多维分析）
result_pivot = df.pivot_table(values='销量', index='产品', aggfunc='mean')
print("使用 pivot_table：")
print(result_pivot)
print("\n说明：pivot_table 更适合需要交叉分析的场景（行列交叉）\n")
